#!/usr/bin/env python3
"""
ุงุฎุชุจุงุฑ ุณุฑูุน ูุฅุฑุณุงู ุฑุณุงุฆู ุฅูู ูุฌููุนุฉ ุงูุชูุบุฑุงู

ูุฐุง ุงูุณูุฑูุจุช:
1. ูุถูู ุงููุฌููุนุฉ ุงูููุฏูุฉ ุฅูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
2. ููุดุฆ ุฑุณุงูุฉ ุงุฎุชุจุงุฑ
3. ูุฑุณู ุงูุฑุณุงูุฉ ุฅูู ุงููุฌููุนุฉ

ุงุณุชุฎุฏุงู:
python setup_group.py -100xxxxxxxxxx

ุฃู

python setup_group.py  # ูุณูุทูุจ ููู ุฅุฏุฎุงู ูุนุฑู ุงููุฌููุนุฉ
"""

import asyncio
import sys
import logging
from datetime import datetime

# ุฅุนุฏุงุฏ ุงูุชุณุฌูู
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

# ุงุณุชูุฑุงุฏ ูุญุฏุงุช ุงููุดุฑูุน
from bot import broadcast_news
from models import News
import database


def reset_database():
    """ุฅุฒุงูุฉ ุฌููุน ุงููุญุงุฏุซุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช"""
    conn = database.get_db_connection()
    cursor = conn.cursor()
    cursor.execute("DELETE FROM chats")
    conn.commit()
    conn.close()
    logger.info("ุชู ูุณุญ ุฌููุน ุงููุญุงุฏุซุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช")


def add_group(chat_id):
    """ุฅุถุงูุฉ ูุฌููุนุฉ ุฅูู ูุงุนุฏุฉ ุงูุจูุงูุงุช"""
    # ุชุญููู ุฅูู ุฑูู ุตุญูุญ ููุชุฃูุฏ ูู ุตุญุฉ ุงููุนุฑู
    try:
        chat_id = int(chat_id)
    except ValueError:
        logger.error(f"ุตูุบุฉ ูุนุฑู ุงููุญุงุฏุซุฉ ุบูุฑ ุตุงูุญุฉ: {chat_id}. ูุฌุจ ุฃู ุชููู ุฑููุงู ุตุญูุญุงู.")
        return False
    
    # ุฅุถุงูุฉ ุงููุญุงุฏุซุฉ ุฅูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
    chat_title = f"ูุฌููุนุฉ ุฃุฎุจุงุฑ ุงููุฑูุจุชู ุงููุฎุตุตุฉ"
    database.add_chat(chat_id, chat_title, "supergroup")
    logger.info(f"ุชูุช ุฅุถุงูุฉ ูุฌููุนุฉ ุจูุนุฑู {chat_id} ุฅูู ูุงุนุฏุฉ ุงูุจูุงูุงุช")
    return True


def create_test_news():
    """ุฅูุดุงุก ุฎุจุฑ ุงุฎุชุจุงุฑู ูููุฑูุจุชู"""
    return News(
        news_id=f"test-{datetime.now().strftime('%Y%m%d%H%M%S')}",
        title="๐ ุงุฎุชุจุงุฑ: ุฃุฎุจุงุฑ ุจูุชูููู ููุฌููุนุชู",
        content="ูุฐุง ุงุฎุชุจุงุฑ ูุจูุช ุฃุฎุจุงุฑ ุงููุฑูุจุชู ููุชุฃูุฏ ูู ุฅููุงููุฉ ุงูุฅุฑุณุงู ูููุฌููุนุฉ. ุฅุฐุง ููุช ุชุฑู ูุฐู ุงูุฑุณุงูุฉุ ููุฐุง ูุนูู ุฃู ุงูุจูุช ูุนูู ุจุดูู ุตุญูุญ ูููููู ุฅุฑุณุงู ุงูุฃุฎุจุงุฑ ุชููุงุฆูุงู ูููุฌููุนุฉ. ูู ุชุนูู ุฃู ุงูุจูุชูููู ูุฏ ูุชุฌุงูุฒ ุงูู 100 ุฃูู ุฏููุงุฑ ูุฐุง ุงูุนุงูุ",
        source="ุงุฎุชุจุงุฑ ุจูุช ุฃุฎุจุงุฑ ุงููุฑูุจุชู",
        url="https://example.com/crypto-news-test",
        tags=["ุงุฎุชุจุงุฑ", "ุจูุชูููู", "ุฃุฎุจุงุฑ_ูุฑูุจุชู"]
    )


async def send_test_message():
    """ุฅุฑุณุงู ุฑุณุงูุฉ ุงุฎุชุจุงุฑ ุฅูู ุฌููุน ุงููุญุงุฏุซุงุช ุงูููููุฉ"""
    # ุฅูุดุงุก ุฎุจุฑ ุงุฎุชุจุงุฑู
    news = create_test_news()
    
    # ุจุซ ุงูุฎุจุฑ ุฅูู ุฌููุน ุงููุญุงุฏุซุงุช (ูุงูุชู ูุฌุจ ุฃู ุชุชุถูู ุงูุขู ูุฌููุนุชูุง)
    success, errors = await broadcast_news(news)
    
    if success > 0:
        logger.info(f"โ ุชู ุฅุฑุณุงู ุฑุณุงูุฉ ุงูุงุฎุชุจุงุฑ ุจูุฌุงุญ ุฅูู {success} ูุญุงุฏุซุฉ")
        return True
    else:
        logger.error(f"โ ูุดู ุฅุฑุณุงู ุฑุณุงุฆู ุงูุงุฎุชุจุงุฑ. ุงูุฃุฎุทุงุก: {errors}")
        return False


async def main():
    """ุงููุธููุฉ ุงูุฑุฆูุณูุฉ"""
    print("๐ ุงุฎุชุจุงุฑ ุฅุฑุณุงู ุฑุณุงุฆู ุฅูู ูุฌููุนุฉ ุงูุชูุบุฑุงู")
    print("-" * 50)
    
    if len(sys.argv) < 2:
        # ุงูุญุตูู ุนูู ุงููุนูููุงุช ูู ุงููุณุชุฎุฏู
        print("\n๐ ุฃุฏุฎู ูุนุฑู ุงููุฌููุนุฉ:")
        print("(ููููู ุงูุญุตูู ุนูู ุงููุนุฑู ูู ูุทูุฑ ุงูุจูุชุ ุนุงุฏุฉู ูููู ุจุงูุตูุบุฉ -100xxxxxxxxxx)")
        chat_id = input("> ").strip()
    else:
        chat_id = sys.argv[1]
    
    # ูุณุญ ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุฅุถุงูุฉ ุงููุฌููุนุฉ ุงููุณุชูุฏูุฉ ููุท
    reset_database()
    
    if not add_group(chat_id):
        print("โ ูุดู ุฅุถุงูุฉ ุงููุฌููุนุฉ. ุชุฃูุฏ ูู ุตุญุฉ ูุนุฑู ุงููุญุงุฏุซุฉ.")
        return
    
    print(f"\nโ ุชูุช ุฅุถุงูุฉ ุงููุฌููุนุฉ ุจูุนุฑู {chat_id} ุฅูู ูุงุนุฏุฉ ุงูุจูุงูุงุช")
    
    # ุฅุฑุณุงู ุฑุณุงูุฉ ุงุฎุชุจุงุฑ
    print("\n๐ ุฌุงุฑู ุฅุฑุณุงู ุฑุณุงูุฉ ุงุฎุชุจุงุฑูุฉ...")
    success = await send_test_message()
    
    if success:
        print("โ ุชู ุฅุฑุณุงู ุงูุฑุณุงูุฉ ุงูุงุฎุชุจุงุฑูุฉ ุจูุฌุงุญ!")
        print("ุชุญูู ูู ุงููุฌููุนุฉ ููุชุฃูุฏ ูู ูุตูู ุงูุฑุณุงูุฉ")
    else:
        print("โ ูุดู ุฅุฑุณุงู ุงูุฑุณุงูุฉ ุงูุงุฎุชุจุงุฑูุฉ. ุชุญูู ูู ุณุฌูุงุช ุงูุฎุงุฏู ููุฒูุฏ ูู ุงูุชูุงุตูู.")
        print("ุชุฃูุฏ ูู:")
        print("1. ุฃู ุงูุจูุช ุนุถู ูู ุงููุฌููุนุฉ (ุฃุถู @Crypto_news_invtron_bot ุฅูู ุงููุฌููุนุฉ)")
        print("2. ุฃู ููุจูุช ุตูุงุญูุงุช ุฅุฑุณุงู ุงูุฑุณุงุฆู")
        print("3. ุฃู ูุนุฑู ุงููุฌููุนุฉ ุตุญูุญ")


if __name__ == "__main__":
    asyncio.run(main())